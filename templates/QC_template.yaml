# =============================================================================
# QC Session (Microscopy Core) — fully documented template
# =============================================================================
# Goal:
# - One YAML file per QC session (self-contained record).
# - Humans enter: context + manual readings (e.g., power meter, temperature).
# - Scripts add: computed metrics (PSF, co-registration, stage repeatability, laser stats).
# - CI (GitHub Action) adds: evaluation (pass/warn/fail) against benchmarks.
#
# Key design rules:
# - Humans MUST NOT write pass/fail. Only CI writes `evaluation`.
# - Human-entered laser data is structured as series (linearity and/or stability).
# - Large artifacts (raw images, CSV logs) live in OMERO; YAML stores pointers.
# - Metric IDs explicitly encode hardware IDs and measurement protocols to prevent 
#   "apples to oranges" comparisons on the dashboard charts.
# =============================================================================

schema_version: 1
record_type: qc_session

# -----------------------------------------------------------------------------
# Identity and timing
# -----------------------------------------------------------------------------
qc_id: "qc_<microscope>_<YYYYMMDDThhmmZ>_<suite>"     # Unique ID for this QC session
microscope: "<instrument_id>"                        # Must match your instrument registry ID

started_utc: "2026-02-16T08:15:00Z"                  # ISO-8601 UTC time (required)
ended_utc: "2026-02-16T09:05:00Z"                    # ISO-8601 UTC time (optional)

performed_by: "<name_or_user_id>"                    # Who ran the QC
reason: "monthly_qc"                                 # Free text: monthly_qc / post_service / troubleshooting / etc.

# Human readable summary (no verdicts here)
summary: "Free text summary of what was done and what looked abnormal (if anything)."
notes: >
  Free text notes: conditions, sample lot, anomalies, room conditions, changes vs baseline, etc.

# -----------------------------------------------------------------------------
# What was performed (human narrative, no pass/fail)
# -----------------------------------------------------------------------------
# Use this for UI display and traceability.
# It should describe what datasets exist and where they are stored.
performed:
  - qc_type: "laser_power"                           # laser_power | psf | alignment | stage | other
    details: >
      Power meter series recorded for linearity and stability.
      Measurement position recorded below.
    artifacts: ["art_laser_linearity_csv", "art_laser_stability_csv"]

  - qc_type: "psf"
    details: "175 nm beads; central ROI; 60x Silicon and 100x Oil objectives."
    artifacts: ["art_psf_stack_raw", "art_psf_preview"]

  - qc_type: "alignment"
    details: "Multicolor beads; co-registration computed."
    artifacts: ["art_coreg_stack_raw", "art_coreg_preview"]

  - qc_type: "stage"
    details: "Repeatability test; 20 cycles; bead centroid tracking."
    artifacts: ["art_stage_repeat_raw", "art_stage_repeat_plot"]

# -----------------------------------------------------------------------------
# HUMAN INPUTS (typed by operator; scripts should not overwrite)
# -----------------------------------------------------------------------------
# Keep general manual checks here (strings or numbers).
inputs_human:
  - metric_id: "visual.optics_clean"                 # Suggested convention: visual.* for manual checks
    value: "yes"                                     # Allow string values for checklists
    unit: ""                                         # Unit can be empty for categorical checks
    details: "Objective front lens inspected."

  - metric_id: "environment.room_temperature_c"
    value: 20
    unit: "C"
    details: "Critical for Silicon/Oil immersion spherical aberration tracking."

# -----------------------------------------------------------------------------
# LASER INPUTS (human-entered structured series)
# -----------------------------------------------------------------------------
laser_inputs_human:

  measurement_position: "at_objective"               # at_objective | pre_objective | fiber_output
  measurement_position_details: >
    Describe adapter used, where sensor placed, objective used (if relevant),
    and whether this is comparable to prior sessions.

  power_meter:
    model: "<meter model>"                           # Free text
    serial: "<optional serial>"
    calibration_due: "<YYYY-MM-DD or free text>"
    integration_time_s: 1.0                          # Optional; helps reproduce noisy readings
    notes: "Any other context (attenuators, adapters, sensor type)."

  linearity_series:
    - laser: "488"                                   # Simple identifier; consistent across your system
      setpoint_units: "percent"                      # percent is typical; can be "percent" or "mW_setpoint"
      power_units: "mW"
      points:                                        # Optional if csv_artifact provided
        - setpoint: 10
          power: 0.24
        - setpoint: 20
          power: 0.48
        - setpoint: 50
          power: 1.20
        - setpoint: 100
          power: 2.35
      csv_artifact: "art_laser_linearity_csv"        # Optional but recommended for full resolution
      details: >
        Setpoint sweep for linearity check.
        If replicates were acquired, note here or in CSV.

  stability_series:
    - laser: "488"
      setpoint: 80
      setpoint_units: "percent"
      sampling: "every 30 s for 120 min"
      power_units: "mW"
      csv_artifact: "art_laser_stability_csv"        # Preferred for long series
      details: "Long-term stability stored in CSV."

# -----------------------------------------------------------------------------
# COMPUTED METRICS (written by scripts; can be appended later)
# -----------------------------------------------------------------------------
# Scripts should write here, not in human sections.
computed_provenance:
  pipeline: "turku_psf_analyzer"                     # Name of your custom Python tool
  version: "1.0.0"                                   # Pipeline version
  git_commit: "abcdef1"                              # Commit hash of analysis code
  run_utc: "2026-02-16T09:02:00Z"                    # When analysis ran

# =============================================================================
# NAMING CONVENTIONS FOR STRICT LONGITUDINAL TRACKING (Dashboard Compatibility)
# =============================================================================
# - Absolute Lasers: laser.<position>.<wavelength>.<setpoint>.<metric> 
#                    (e.g., laser.at_obj.488.100pct.power_mw)
# - Relative Lasers: laser.<wavelength>.<metric> 
#                    (e.g., laser.488.linearity_r2)
# - Optical/PSF:     psf.<objective_id>.<channel_nm>.<metric> 
#                    (e.g., psf.60x_sil.525.fwhm_z_nm)
# - Chromatic Shift: chromatic_shift.<objective_id>.<target_wl>_to_<ref_wl>.<metric>
# =============================================================================

metrics_computed:

  # --- ABSOLUTE LASER METRICS (Protocol specific) ---
  - metric_id: "laser.at_obj.488.100pct.power_mw"
    value: 2.35
    unit: "mW"
    details: "Max power at objective. Will spawn a separate chart from fiber measurements."

  # --- RELATIVE LASER METRICS (Comparable across setups) ---
  - metric_id: "laser.488.linearity_r2"
    value: 0.998
    unit: "unitless"
    details: "Regression of power vs setpoint (linearity_series)."

  - metric_id: "laser.488.stability_long_delta_pct"
    value: 2.4
    unit: "percent"
    details: "Δ% computed from long-term stability series."


  # --- PSF METRICS (Namespaced by objective ID and channel) ---
  - metric_id: "psf.60x_sil.525.fwhm_xy_max_nm"
    value: 288.3
    unit: "nm"
    details: "Gaussian fit; N=93 beads."

  - metric_id: "psf.60x_sil.525.fwhm_z_nm"
    value: 853.2
    unit: "nm"

  - metric_id: "psf.60x_sil.525.asymmetry"
    value: 0.93
    unit: "unitless"

  # --- CHROMATIC SHIFT (Namespaced by objective ID) ---
  - metric_id: "chromatic_shift.60x_sil.425_to_525.z_nm"
    value: 127.5
    unit: "nm"
    details: "Axial shift of 425nm channel relative to 525nm."


  # --- STAGE / HARDWARE METRICS ---
  - metric_id: "stage.repeatability_sigma_x_nm"
    value: 180
    unit: "nm"
    details: "Std dev of centroid X over 20 cycles."

# -----------------------------------------------------------------------------
# EVALUATION (machine-generated; GitHub Action writes/updates this block)
# -----------------------------------------------------------------------------
# CI compares computed metrics to a benchmark file and writes verdicts here.
# Humans should not edit this block.
evaluation:
  benchmark_ref: "benchmarks/<microscope>.yaml@<git_sha_or_tag>"   # Make evaluation reproducible
  evaluated_utc: "2026-02-16T09:03:30Z"
  evaluated_by: "github_action:qceval"
  overall_status: "warn"                                          # pass | warn | fail

  results:
    - metric_id: "laser.488.stability_long_delta_pct"
      status: "pass"
      threshold: "warn>3.0%, fail>5.0%"
      message: ""

    - metric_id: "psf.60x_sil.525.fwhm_z_nm"
      status: "warn"
      threshold: "warn>900nm, fail>1000nm"
      message: "Z approaching upper threshold."

# -----------------------------------------------------------------------------
# ARTIFACT POINTERS (raw data in OMERO; previews/plots can be in repo)
# -----------------------------------------------------------------------------
# Use stable URIs/IDs. The YAML is the ledger; OMERO is the raw data store.
artifacts:
  - artifact_id: "art_laser_linearity_csv"
    role: "table"                                   # table | raw_image | preview | report | other
    uri: "omero://<server>/<group>/dataset/<id>/file/laser_linearity.csv"
    description: "Laser setpoint sweep (linearity)."

  - artifact_id: "art_psf_stack_raw_60x_sil"
    role: "raw_image"
    uri: "omero://<server>/<group>/image/<id>"
    description: "Raw sub-diffraction bead stack for 60x Silicon."
    checksum_sha256: "<optional>"

  - artifact_id: "art_psf_preview_60x_sil"
    role: "preview"
    uri: "qc/<microscope>/<YYYY>/previews/<qc_id>_60x_sil_mip.png"
    description: "XY Maximum Intensity Projection preview."

  - artifact_id: "art_stage_repeat_raw"
    role: "raw_image"
    uri: "omero://<server>/<group>/image/<id>"
    description: "Stage repeatability acquisition."

  - artifact_id: "art_stage_repeat_plot"
    role: "preview"
    uri: "qc/<microscope>/<YYYY>/previews/<qc_id>_stage_repeat.png"
    description: "Repeatability plot."

# {% if instrument.url %}[{{ instrument.display_name }}]({{ instrument.url }}){:target="_blank"}{% else %}{{ instrument.display_name }}{% endif %}

<div class="aic-topactions" markdown="span">
  [üìä View QC & Maintenance History](history.md){ .md-button .md-button--primary }
</div>

{% set status_class = 'success' if instrument.status.color == 'green' else 'warning' if instrument.status.color == 'yellow' else 'danger' %}
!!! {{ status_class }} "Current Status: {{ instrument.status.badge }}"
    {{ instrument.status.reason }}

<div class="aic-hero">
  <div class="aic-hero__media">
    <img src="../../assets/images/{{ instrument.image_filename }}" alt="{{ instrument.display_name }}"
         onerror="this.onerror=null; this.src='../../assets/images/placeholder.svg';" />
  </div>

  <div class="aic-hero__facts">
    <div class="aic-facts">
      <div class="aic-fact">
        <div class="aic-muted">Instrument ID</div>
        <div><code>{{ instrument.id }}</code></div>
      </div>
      <div class="aic-fact">
        <div class="aic-muted">Manufacturer</div>
        <div>{{ instrument.manufacturer or '‚Äî' }}</div>
      </div>
      <div class="aic-fact">
        <div class="aic-muted">Model</div>
        <div>{{ instrument.model or '‚Äî' }}</div>
      </div>
      <div class="aic-fact">
        <div class="aic-muted">Stand</div>
        <div>{{ instrument.stand_orientation or '‚Äî' }}</div>
      </div>
    </div>

    <div class="aic-section">
      <div class="aic-section__title">Modalities</div>
      <div class="aic-chiprow">
        {% for mod in instrument.modalities %}
          <span class="aic-chip">{{ mod }}</span>
        {% else %}
          <span class="aic-muted">‚Äî</span>
        {% endfor %}
      </div>
    </div>

    {% if instrument.modules %}
    <div class="aic-section">
      <div class="aic-section__title">Modules</div>
      <div class="aic-chiprow">
        {% for m in instrument.modules %}
          {% if m.url %}
            <a href="{{ m.url }}" target="_blank" class="aic-chip aic-chip--muted" title="{{ m.notes }}">{{ m.name }} ‚Üó</a>
          {% else %}
            <span class="aic-chip aic-chip--muted" title="{{ m.notes }}">{{ m.name }}</span>
          {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
</div>

{% if instrument.notes %}
## Capabilities (Legacy Notes)

{% if instrument.notes.type %}
- **Type:** {{ instrument.notes.type }}
{% endif %}

{% if instrument.notes.imaging_modes %}
- **Imaging modes:** {{ instrument.notes.imaging_modes | join(', ') }}
{% endif %}

{% if instrument.notes.filters %}
- **Filters:**
{% for f in instrument.notes.filters %}
  - {{ f }}
{% endfor %}
{% endif %}

{% if instrument.notes.additional_hardware %}
- **Additional hardware:**
{% for h in instrument.notes.additional_hardware %}
  - {{ h }}
{% endfor %}
{% endif %}

{% if instrument.notes.raw %}
- **Notes:** {{ instrument.notes.raw }}
{% endif %}
{% endif %}

## Software Environment

{% if instrument.software %}
<div class="grid cards" markdown>

{% for sw in instrument.software %}
-   **{% if sw.url %}[{{ sw.name or 'Unknown Software' }}]({{ sw.url }}){:target="_blank"}{% else %}{{ sw.name or 'Unknown Software' }}{% endif %}**

    ---

    <span class="aic-muted">Component:</span> {{ sw.component or '‚Äî' }}<br>
    {% if sw.version %}<span class="aic-muted">Version:</span> `{{ sw.version }}`{% endif %}

{% endfor %}

</div>
{% else %}
> *No software configurations recorded.*
{% endif %}

---

## Hardware Configuration

### üí° Light Sources

{% if light_sources %}
<div class="grid cards" markdown>

{% for src in light_sources %}
-   **{% if src.url %}[{{ src.name or 'Unknown Model' }}]({{ src.url }}){:target="_blank"}{% else %}{{ src.name or 'Unknown Model' }}{% endif %}**

    ---

    **Type:** {{ src.type or '‚Äî' }}
    {% if src.wavelength %}<br>**Wavelength:** `{{ src.wavelength }} nm`{% endif %}
    {% if src.power %}<br>**Power:** `{{ src.power }}`{% endif %}
    {% if src.notes %}<br><small class="aic-muted">{{ src.notes }}</small>{% endif %}

{% endfor %}

</div>
{% else %}
> *No light sources recorded.*
{% endif %}

### üì∑ Detectors

{% if detectors %}
<div class="grid cards" markdown>

{% for det in detectors %}
-   **{% if det.url %}[{{ det.name or 'Unknown' }} {{ det.model or '' }}]({{ det.url }}){:target="_blank"}{% else %}{{ det.name or 'Unknown' }} {{ det.model or '' }}{% endif %}**

    ---

    **Type:** {{ det.type or '‚Äî' }}
    {% if det.notes %}<br><small class="aic-muted">{{ det.notes }}</small>{% endif %}

{% endfor %}

</div>
{% else %}
> *No detectors recorded.*
{% endif %}

### üî¨ Objectives

{% if objectives %}
<div class="grid cards" markdown>

{% for obj in objectives %}
-   **{% if obj.url %}[{{ obj.name or 'Unknown Model' }}]({{ obj.url }}){:target="_blank"}{% else %}{{ obj.name or 'Unknown Model' }}{% endif %}**

    ---

    **Mag:** `{{ obj.magnification if obj.magnification is not none else '‚Äî' }}x` | **NA:** `{{ obj.na if obj.na is not none else '‚Äî' }}`
    {% if obj.immersion %}<br>**Immersion:** {{ obj.immersion }}{% endif %}
    {% if obj.wd %}<br>**WD:** {{ obj.wd }}{% endif %}
    {% if obj.correction %}<br>**Correction:** {{ obj.correction }}{% endif %}
    {% if obj.notes %}<br><small class="aic-muted">{{ obj.notes }}</small>{% endif %}

{% endfor %}

</div>
{% else %}
> *No objectives recorded.*
{% endif %}


### üéõÔ∏è Filters & Splitters

<div class="grid cards" markdown>

{% if filters %}
-   **Optical Filters**

    ---

    {% for f in filters %}
    * {% if f.url %}[**{{ f.name or 'Filter' }}**]({{ f.url }}){:target="_blank"}{% else %}**{{ f.name or 'Filter' }}**{% endif %}
      {% if f.excitation or f.emission %}
      <br><small class="aic-muted">EX: {{ f.excitation or '-' }} | EM: {{ f.emission or '-' }}</small>
      {% endif %}
    {% endfor %}
{% endif %}

{% if splitters %}
-   **Splitters / Dichroics**

    ---

    {% for s in splitters %}
    * {% if s.url %}[**{{ s.name or 'Splitter' }}**]({{ s.url }}){:target="_blank"}{% else %}**{{ s.name or 'Splitter' }}**{% endif %}
      {% if s.type %}<br><small class="aic-muted">Type: {{ s.type }}</small>{% endif %}
    {% endfor %}
{% endif %}

{% if not filters and not splitters %}
-   **Optical Components**

    ---

    > *No filters or splitters recorded.*
{% endif %}

</div>

---

## QC Metrics

### Latest Measurements

{% if latest_metrics %}
<div class="grid cards" markdown>

{% for m_id, m_val in latest_metrics.items() %}
-   **{{ metric_names.get(m_id, m_id) }}**

    ---

    <span style="font-size: 1.5em; font-weight: bold; color: var(--md-primary-fg-color);">{{ m_val }}</span><br>
    <span class="aic-muted" style="font-size: 0.8em;"><code>{{ m_id }}</code></span>

{% endfor %}

</div>
{% else %}
> *No recent metrics available.*
{% endif %}
